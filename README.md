# Optimization of CHSH Inequality Violation Using SDP

This repository presents code for finding the most optimal quantum state and measurement device settings to achieve the maximum [CHSH inequality](https://en.wikipedia.org/wiki/CHSH_inequality)[^1] violation. The main objective is to determine the minimum detector accuracy that still allows detection of any CHSH violation. The code relies on [semidefinite programming (SDP)](https://en.wikipedia.org/wiki/Semidefinite_programming)[^2][^3] implemented in [CVXPY](https://www.cvxpy.org/)[^4].

## Method Overview and Results

Because the full problem is not convex, we cannot directly find the most optimal solution.  
We therefore separate the problem into two smaller subproblems: optimizing the state and optimizing the measurement settings.  
The more detailed description of these optimizations is presented in the following sections.  
We then iterate between these two optimizations over many initial conditions.  

This method allowed us to find an upper bound on the detector accuracy:

$$
\mu^{*} \approx 0.708
$$

With the state:

$$
\rho = 
\begin{bmatrix}
  0.36073 + 0.00000i &  0.04544 - 0.21949i &  0.20770 - 0.08427i &  0.06504 + 0.35481i \\
  0.04544 + 0.21949i &  0.13927 + 0.00000i &  0.07744 + 0.11576i & -0.20770 + 0.08427i \\
  0.20770 + 0.08427i &  0.07744 - 0.11576i &  0.13927 + 0.00000i & -0.04544 + 0.21949i \\
  0.06504 - 0.35481i & -0.20770 - 0.08427i & -0.04544 - 0.21949i &  0.36073 + 0.00000i
\end{bmatrix}
$$

Error state:

$$
\rho_{\text{err}} = \frac{\mathbb{1}_4}{4}
$$

And the measurement:

$$
A_1 = \begin{bmatrix}
  0.40134 + 0.00000i &  0.85317 - 0.33322i \\
  0.85317 + 0.33322i & -0.40134 + 0.00000i
\end{bmatrix},
\quad
A_2 = \begin{bmatrix}
  0.81656 + 0.00000i & -0.49808 - 0.29179i \\
 -0.49808 + 0.29179i & -0.81656 + 0.00000i
\end{bmatrix},
$$

$$
B_1 = \begin{bmatrix}
  0.73899 + 0.00000i & -0.18787 - 0.64699i \\
 -0.18787 + 0.64699i & -0.73899 + 0.00000i
\end{bmatrix},
\quad
B_2 = \begin{bmatrix}
  0.67364 + 0.00000i &  0.19134 + 0.71387i \\
  0.19134 - 0.71387i & -0.67364 + 0.00000i
\end{bmatrix}
$$

Gives violation of

$$
\text{CHSH} = 2.00252
$$

## Files description

`pyproject.toml` - declares used packages  
`poetry.lock` - frozen, resolved dependencies generated by poetry  
`src\const.py` - constants and universally used functions  
`src\measurement_optimization.py` - code for optimizing the measurement settings  
`src\state_optimization.py` - code for optimizing the state  
`src\test.py` - quick tests for both optimizations separately, based on[^8]  
`src\imperfect_detector` - code used for finding the upper bound on detector accuracy  

## Deeper view on optimization

This section presents several derivations used in the code.

### Optimizing the State

This is the simplest case: the problem is a basic SDP because the CHSH inequality can be expressed as[^5]

$$
C = A_1 \otimes (B_1 + B_2) + A_2 \otimes (B_1 - B_2),
$$

where $A_1$ and $A_2$ are one party’s measurement settings, and $B_1$ and $B_2$ are the other’s. The task is to maximize 

$$
\text{tr}(C \rho_{text{eff}}),
$$

If we separate $\rho_{text{eff}}$ into the perturbation $\rho_{err}$ and state we do have control $\rho$ the problem still remain convex.

$$
\rho_{text{eff}} = \mu \rho + (1 - \mu) \rho_{err}
$$

where each $\rho$, $\rho_{err}$ and $\rho_{text{eff}}$ is the [density matrix](https://en.wikipedia.org/wiki/Density_matrix)[^6][^7] of the quantum state. The probabilities must sum to 1, giving the SDP constraint

$$
\text{tr}(\rho) = 1,
$$


### Optimizing the Measurement

If we rewrite the CHSH expression:

$$
\text{CHSH} = \text{tr}\left[ \left( A_1 \otimes B_1 + A_1 \otimes B_2 + A_2 \otimes B_1 - A_2 \otimes B_2 \right) \rho \right] = \text{tr}(A_1 K_{A_1}),
$$

where

$$
K_{A_1} = \text{tr}_B \left[ \left( I_A \otimes (B_1 + B_2) \right) \rho \right],
$$

we used $\text{tr}_B$ as partial trace over second subspace. Optimizing $\text{tr}(A_1 K_{A_1})$ is a convex problem.  
Moreover, with the constraints that $A$ is Hermitian and has eigenvalues in the range $[-1, 1]$, the problem has a closed-form solution.  
This can be seen using the [von Neumann trace inequality](https://en.wikipedia.org/wiki/Trace_inequality)[^9]:

$$
\text{tr}(A K) = \text{tr}(A U \Lambda U^{\dagger}) = \text{tr}(U^{\dagger} A U  \Lambda) = \text{tr}(\tilde{A} \Lambda) \leq \sum_i \sigma_i(\tilde{A})  \sigma_i(\Lambda),
$$

where $K = U \Lambda U^{\dagger}$ is the spectral decomposition, and $\sigma_i(\cdot)$ denotes singular values.

From this, we see that the optimal choice is

$$
A^{*} = U  \text{sgn}(K)  U^{\dagger},
$$

which yields the largest CHSH violation.  
To optimize other setting we use different $K$:

$$
K_{A_2} = \text{tr}_B \left[ \left( I_A \otimes (B_1 - B_2) \right) \rho \right],
$$

$$
K_{B_1} = \text{tr}_A \left[ \left( (A_1 + A_2) \otimes I_B \right) \rho \right],
$$

$$
K_{B_2} = \text{tr}_A \left[ \left( (A_1 - A_2) \otimes I_B \right) \rho \right],
$$

this allow to maximize all measurement settings.

---

# References
[^1]: https://en.wikipedia.org/wiki/CHSH_inequality  
[^2]: https://en.wikipedia.org/wiki/Semidefinite_programming  
[^3]: Robert M. Freund, *Introduction to Semidefinite Programming (SDP)*, 2004, https://ocw.mit.edu/courses/15-084j-nonlinear-programming-spring-2004/a632b565602fd2eb3be574c537eea095_lec23_semidef_opt.pdf  
[^4]: https://www.cvxpy.org/index.html  
[^5]: https://qubit.guide/6.3-chsh-inequality  
[^6]: https://en.wikipedia.org/wiki/Density_matrix  
[^7]: Caltech Ph219/CS219 Quantum Computation, https://www.preskill.caltech.edu/ph219/ph219_2021-22.html  
[^8]: https://en.wikipedia.org/wiki/Bell%27s_theorem  
[^9]: https://en.wikipedia.org/wiki/Trace_inequality
